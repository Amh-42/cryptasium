{% extends "base.html" %}

{% block title %}Blog | Cryptasium{% endblock %}

{% block content %}
<!-- HERO SECTION -->
<header>
    <div class="container">
        <div class="reveal">
            <div class="tag">● TECHNICAL WRITING</div>
            <h1 class="text-6xl md:text-7xl lg:text-8xl font-bold leading-tight mb-6">Code, concepts,<br>and deep dives.</h1>
            <p class="hero-desc text-xl text-[var(--text-muted)] max-w-2xl mx-auto mb-10 leading-relaxed">Written companions to our videos with code snippets, technical references, and extended explorations of the ideas we visualize.</p>
            <div class="flex flex-wrap gap-4 justify-center">
                <a href="#articles" class="btn btn-primary">Latest Article</a>
                <a href="{{ url_for('index') }}" class="btn btn-outline">Back to Home</a>
            </div>
        </div>
    </div>
</header>

<!-- LATEST ARTICLES -->
<section id="articles" class="container relative py-24 px-6">
    <!-- Semi-transparent glassmorphism container -->
    <div class="glass-container reveal">
        <div class="reveal">
            <h2 class="text-5xl font-bold text-center mb-16 text-white">Recent Articles</h2>
        </div>
        <div class="content-grid">
            {% if posts.items %}
                {% for post in posts.items %}
                <div class="content-card reveal">
                    {% if post.featured_image %}
                    <div class="video-placeholder" style="height: 200px; margin-bottom: 20px; background-image: url('{{ post.featured_image }}'); background-size: cover; background-position: center;">
                    </div>
                    {% else %}
                    <div class="video-placeholder" style="height: 200px; margin-bottom: 20px;">
                        <i class="ph ph-article placeholder-icon"></i>
                        <span class="placeholder-text">Article</span>
                    </div>
                    {% endif %}
                    <h3 class="mb-3 text-xl font-semibold"><a href="{{ url_for('blog_detail', slug=post.slug) }}" class="hover:text-[var(--accent)] transition-colors">{{ post.title }}</a></h3>
                    <p class="text-[var(--text-muted)] text-sm mb-4 leading-relaxed">{{ post.excerpt or post.content[:150] + '...' if post.content else 'Read more...' }}</p>
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-[var(--text-muted)] text-xs font-mono">{{ post.author }} • {{ post.created_at.strftime('%b %d, %Y') if post.created_at else '' }}</span>
                        <span class="text-[var(--text-muted)] text-xs">{{ post.views or 0 }} views</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="reveal col-span-full text-center py-16">
                <p class="text-[var(--text-muted)] text-lg">No blog posts yet. Check back soon!</p>
            </div>
            {% endif %}
        </div>

        <!-- PAGINATION -->
        {% if posts.pages > 1 %}
        <div class="pagination">
            {% if posts.has_prev %}
            <a href="{{ url_for('blog_list', page=posts.prev_num) }}" class="hover:border-[var(--accent)] hover:text-[var(--accent)] transition-colors">Previous</a>
            {% endif %}
            
            {% for page_num in posts.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num == posts.page %}
                    <span class="current">{{ page_num }}</span>
                    {% else %}
                    <a href="{{ url_for('blog_list', page=page_num) }}" class="hover:border-[var(--accent)] hover:text-[var(--accent)] transition-colors">{{ page_num }}</a>
                    {% endif %}
                {% else %}
                <span>...</span>
                {% endif %}
            {% endfor %}
            
            {% if posts.has_next %}
            <a href="{{ url_for('blog_list', page=posts.next_num) }}" class="hover:border-[var(--accent)] hover:text-[var(--accent)] transition-colors">Next</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>

<!-- INTERACTIVE DEMO: SYSTEM COMPLEXITY -->
<section class="container relative py-32 px-6">
    <div class="reveal text-center mb-20">
        <div class="tag mb-6">● INTERACTIVE DEMO</div>
        <h2 class="text-5xl md:text-6xl font-bold leading-tight mb-6">Visualizing System Complexity</h2>
        <p class="text-[var(--text-muted)] text-xl max-w-3xl mx-auto leading-relaxed mb-4">
            Explore how computational systems scale from simple algorithms to complex neural networks. 
            This interactive visualization demonstrates the relationship between system complexity, 
            processing intensity, and emergent behaviors—core concepts in understanding modern technology.
        </p>
        <p class="text-[var(--text-muted)] text-sm mt-4 font-mono opacity-70">
            Adjust the complexity level. Neural signals appear when complexity exceeds threshold.
        </p>
    </div>

    <!-- SVG Filter for Turbulent Displacement -->
    <svg style="position:absolute; width:0; height:0;">
        <defs>
            <filter id="turbulent-displace" colorInterpolationFilters="sRGB" x="-20%" y="-20%" width="140%" height="140%">
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="1" />
                <feOffset in="noise1" dx="0" dy="0" result="offsetNoise1">
                    <animate attributeName="dy" values="700; 0" dur="6s" repeatCount="indefinite" calcMode="linear" />
                </feOffset>
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="1" />
                <feOffset in="noise2" dx="0" dy="0" result="offsetNoise2">
                    <animate attributeName="dy" values="0; -700" dur="6s" repeatCount="indefinite" calcMode="linear" />
                </feOffset>
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise3" seed="2" />
                <feOffset in="noise3" dx="0" dy="0" result="offsetNoise3">
                    <animate attributeName="dx" values="490; 0" dur="6s" repeatCount="indefinite" calcMode="linear" />
                </feOffset>
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise4" seed="2" />
                <feOffset in="noise4" dx="0" dy="0" result="offsetNoise4">
                    <animate attributeName="dx" values="0; -490" dur="6s" repeatCount="indefinite" calcMode="linear" />
                </feOffset>
                <feComposite in="offsetNoise1" in2="offsetNoise2" result="part1" />
                <feComposite in="noise3" in2="noise4" result="part2" />
                <feBlend in="part1" in2="part2" mode="color-dodge" result="combinedNoise" />
                <feDisplacementMap in="SourceGraphic" in2="combinedNoise" scale="30" xChannelSelector="R" yChannelSelector="B" />
            </filter>
        </defs>
    </svg>

    <div class="thermostat-demo-container reveal">
        <div id="thermostatApp">
            <div class="thermostat-ui">
                <div class="thermostat glass-panel">
                    <div class="thermostat-inner">
                        <div class="glass-noise"></div>
                        <div class="scale-container" id="scaleContainer"></div>
                        <div class="track" id="track">
                            <div class="mercury" id="mercury"></div>
                        </div>
                        <div class="knob-zone">
                            <div class="knob" id="knob"></div>
                        </div>
                    </div>
                </div>
                <div class="temp-readout">
                    <div class="temp-value" id="tempValue">20</div>
                    <div class="temp-label">COMPLEXITY LEVEL</div>
                    <div class="status-text" id="statusText">Simple</div>
                </div>
            </div>
        </div>
        <div class="particles-container" id="uiParticles"></div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'bg-body': '#050505',
                    'bg-card': '#0f0f0f',
                    'border': '#262626',
                    'accent': '#ff2222',
                }
            }
        }
    }
</script>
<style>
    /* --- GLASSMORPHISM CONTAINER --- */
    .glass-container {
        background: rgba(15, 15, 15, 0.6);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 64px 48px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        position: relative;
        overflow: hidden;
    }

    .glass-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(255, 255, 255, 0.1) 50%, 
            transparent
        );
    }

    @media (max-width: 768px) {
        .glass-container {
            padding: 48px 24px;
            border-radius: 16px;
        }
    }

    /* --- ENHANCED CONTENT CARDS --- */
    .content-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .content-card:hover {
        border-color: rgba(255, 34, 34, 0.5);
        background: rgba(255, 255, 255, 0.06);
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3),
                    0 0 0 1px rgba(255, 34, 34, 0.2);
    }

    /* --- THERMOSTAT DEMO STYLES --- */
    .thermostat-demo-container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 600px;
        padding: 60px 0;
    }

    #thermostatApp {
        position: relative;
        z-index: 10;
    }

    :root {
        --glass-bg: rgba(15, 15, 15, 0.8);
        --glass-border: rgba(255, 255, 255, 0.08);
        --glow-color: #00a2fa;
    }

    .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }

    .thermostat-ui {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 28px;
    }

    .thermostat {
        position: relative;
        width: 150px;
        height: 520px;
        border-radius: 999px;
        overflow: visible;
    }

    .thermostat-inner {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: inherit;
        overflow: visible;
    }

    .thermostat-inner::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        border: 1px solid rgba(255,255,255,0.1);
        mix-blend-mode: soft-light;
        pointer-events: none;
    }

    .glass-noise {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        opacity: 0.08;
        mix-blend-mode: overlay;
        pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    }

    .track {
        position: absolute;
        top: 46px;
        bottom: 46px;
        left: 50%;
        transform: translateX(-50%);
        width: 42px;
        border-radius: 999px;
        background:
            radial-gradient(circle at 50% 0%, rgba(255,255,255,0.35) 0, transparent 55%),
            radial-gradient(circle at 50% 100%, rgba(0,0,0,1) 0, rgba(0,0,0,0.9) 70%),
            linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.8));
        background-blend-mode: screen, normal, soft-light;
        box-shadow: inset 0 0 18px rgba(0,0,0,1), 0 0 18px rgba(0,0,0,0.8);
        overflow: hidden;
    }

    .mercury {
        position: absolute;
        bottom: 0;
        left: -45%;
        width: 190%;
        height: 0%;
        background: var(--glow-color);
        filter: url(#turbulent-displace);
        mix-blend-mode: screen;
        box-shadow: 0 0 45px var(--glow-color), 0 0 90px var(--glow-color);
        transition: height 0.12s linear, box-shadow 0.3s ease, background 0.25s ease;
        opacity: 0.95;
    }

    .mercury::before,
    .mercury::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        filter: blur(6px);
        background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.3), transparent 90%);
        mix-blend-mode: color-dodge;
        opacity: 0.25;
        animation: pulseElectric 3s infinite ease-in-out alternate;
    }

    .mercury::after {
        filter: blur(16px);
        opacity: 0.18;
        animation-delay: 1.5s;
    }

    @keyframes pulseElectric {
        0% { opacity: 0.15; transform: scaleY(1); }
        100% { opacity: 0.35; transform: scaleY(1.05); }
    }

    .knob-zone {
        position: absolute;
        top: 46px;
        bottom: 46px;
        left: 0;
        right: 0;
        pointer-events: none;
    }

    .knob {
        position: absolute;
        left: 50%;
        top: 0;
        transform: translate(-50%, -50%);
        width: 72px;
        height: 72px;
        border-radius: 999px;
        background: rgba(10,10,10,0.7);
        backdrop-filter: blur(12px) saturate(260%) brightness(1.25);
        -webkit-backdrop-filter: blur(12px) saturate(260%) brightness(1.25);
        border: 1px solid rgba(255,255,255,0.14);
        box-shadow: inset 0 1px 18px rgba(255,255,255,0.15), 0 8px 26px rgba(0,0,0,0.9);
        cursor: grab;
        pointer-events: auto;
        transition: box-shadow 0.2s ease, transform 0.15s ease;
        z-index: 20;
    }

    .knob:active {
        transform: translate(-50%, -50%) scale(1.05);
        cursor: grabbing;
    }

    .scale-container {
        position: absolute;
        top: 46px;
        bottom: 46px;
        left: -90px;
        width: 80px;
        pointer-events: none;
    }

    .scale-mark {
        position: absolute;
        right: 0;
        font-size: 14px;
        color: rgba(255,255,255,0.35);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transform-origin: right center;
        transition: all 0.1s ease;
        font-family: var(--font-sans);
    }

    .tick {
        height: 2px;
        background: rgba(255,255,255,0.4);
        border-radius: 2px;
        flex-shrink: 0;
    }

    .temp-readout {
        text-align: center;
    }

    .temp-value {
        font-size: 5.2rem;
        font-weight: 700;
        text-shadow: 0 0 48px var(--glow-color);
        color: var(--glow-color);
        font-family: var(--font-sans);
    }

    .temp-value::after {
        content: "%";
        font-size: 3rem;
        opacity: 0.8;
    }

    .temp-label {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.34em;
        opacity: 0.7;
        margin-top: 10px;
        font-family: var(--font-sans);
    }

    .status-text {
        margin-top: 8px;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.22em;
        color: var(--glow-color);
        opacity: 0.95;
        font-family: var(--font-sans);
    }

    .particles-container {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
    }

    .particle {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
    }

    @media (max-width: 768px) {
        .thermostat {
            transform: scale(0.85);
        }
        .thermostat-demo-container {
            min-height: 500px;
            padding: 40px 0;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
    <!-- GSAP for Thermostat Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>

    <!-- THERMOSTAT INTERACTIVE DEMO -->
    <script>
        // Credit: Inspired by codepen.io/ash_creator and codepen.io/BalintFerenczy
        const CONFIG = {
            minTemp: 20,
            maxTemp: 110,
            defaultTemp: 70,
            gradientColors: ["#00eaff","#0099ff","#00ff73","#ffdd00","#ff8800","#ff0044"],
            gradientStops: [0,0.25,0.5,0.7,0.85,1],
            thresholds: { neural: 40 }
        };

        const els = {
            track: document.getElementById("track"),
            mercury: document.getElementById("mercury"),
            knob: document.getElementById("knob"),
            scaleContainer: document.getElementById("scaleContainer"),
            tempValue: document.getElementById("tempValue"),
            statusText: document.getElementById("statusText"),
            uiParticles: document.getElementById("uiParticles"),
            root: document.documentElement
        };

        let currentTemp = CONFIG.defaultTemp;
        let trackHeight = 0, knobBounds = { minY: 0, maxY: 0 }, scaleItems = [], colorMap;
        let snowParticleIntervalId = null;

        const lerp = (a,b,t) => a + (b - a) * t;

        function createColorMap() {
            const stops = CONFIG.gradientStops;
            const colors = CONFIG.gradientColors.map(c => {
                const hex = c.replace('#', '');
                return [
                    parseInt(hex.substr(0,2), 16),
                    parseInt(hex.substr(2,2), 16),
                    parseInt(hex.substr(4,2), 16)
                ];
            });
            return t => {
                t = Math.max(0, Math.min(1, t));
                for (let i=0; i<stops.length-1; i++) {
                    const s0 = stops[i], s1 = stops[i+1];
                    if (t >= s0 && t <= s1) {
                        const n = (t - s0) / (s1 - s0);
                        const c0 = colors[i], c1 = colors[i+1];
                        return `rgb(${Math.round(lerp(c0[0],c1[0],n))},${Math.round(lerp(c0[1],c1[1],n))},${Math.round(lerp(c0[2],c1[2],n))})`;
                    }
                }
            };
        }

        function buildScale() {
            els.scaleContainer.innerHTML = "";
            scaleItems = [];
            const min = CONFIG.minTemp, max = CONFIG.maxTemp, range = max - min;
            const rect = els.track.getBoundingClientRect();
            const trackH = rect.height;
            
            // Tech concepts ordered by complexity (simple to complex)
            const concepts = [
                { value: 20, label: "Variable" },
                { value: 30, label: "Function" },
                { value: 40, label: "Algorithm" },
                { value: 50, label: "Framework" },
                { value: 60, label: "Architecture" },
                { value: 70, label: "Neural" },
                { value: 80, label: "Transformer" },
                { value: 90, label: "Distributed" },
                { value: 100, label: "Quantum" },
                { value: 110, label: "AGI" }
            ];
            
            for (let t = min; t <= max; t += 2) {
                const el = document.createElement("div");
                el.className = "scale-mark";
                const tick = document.createElement("div");
                tick.className = "tick";
                
                // Find if this position has a concept label
                const concept = concepts.find(c => c.value === t);
                
                if (concept) {
                    tick.style.width = "18px";
                    el.innerHTML = `${concept.label}<div class="tick"></div>`;
                } else if (t % 10 === 0) {
                    tick.style.width = "12px";
                } else if (t % 5 === 0) {
                    tick.style.width = "8px";
                } else {
                    tick.style.width = "6px";
                }
                
                const y = (1 - (t - min) / range) * (trackH - 1);
                el.style.top = `${y}px`;
                if (!concept) el.appendChild(tick);
                el.dataset.temp = t;
                els.scaleContainer.appendChild(el);
                scaleItems.push(el);
            }
        }

        function updateScaleVisuals(knobY){
            scaleItems.forEach(el => {
                const rect = els.track.getBoundingClientRect();
                const elY = parseFloat(el.style.top);
                const dist = Math.abs(knobY - elY), maxDist = 70;
                if (dist < maxDist) {
                    const p = 1 - dist / maxDist;
                    gsap.set(el, { 
                        scale: 1 + p * 0.8, 
                        opacity: 0.6 + p * 0.6, 
                        color: "#fff",
                        textShadow: "0 0 8px var(--glow-color)"
                    });
                } else {
                    gsap.set(el, { 
                        scale: 1, 
                        opacity: 0.3, 
                        color: "rgba(255,255,255,0.35)",
                        textShadow: "none"
                    });
                }
            });
        }

        function updateStatusText(t){
            let txt = "";
            if(t < 32) txt = "Simple";
            else if(t < 55) txt = "Basic";
            else if(t < 66) txt = "Moderate";
            else if(t <= 74) txt = "Complex";
            else if(t < 85) txt = "Advanced";
            else if(t < 95) txt = "Intense";
            else txt = "Extreme";
            els.statusText.textContent = txt;
        }

        function applyColorTheme(color){
            els.root.style.setProperty("--glow-color", color);
            els.tempValue.style.color = color;
            els.statusText.style.color = color;
            els.mercury.style.boxShadow = `0 0 40px ${color}, 0 0 80px ${color}`;
        }

        function updateSystemFromY(yPos){
            yPos = Math.max(knobBounds.minY, Math.min(knobBounds.maxY, yPos));
            const pct = 1 - yPos / trackHeight;
            const temp = CONFIG.minTemp + pct * (CONFIG.maxTemp - CONFIG.minTemp);
            currentTemp = Math.round(temp);
            const norm = (currentTemp - CONFIG.minTemp) / (CONFIG.maxTemp - CONFIG.minTemp);
            const color = colorMap(norm);
            els.tempValue.textContent = currentTemp;
            els.mercury.style.height = pct * 100 + "%";
            applyColorTheme(color);
            updateStatusText(currentTemp);
            updateScaleVisuals(yPos);
            updateSnowParticles(currentTemp);
        }

        function initLayout(){
            const rect = els.track.getBoundingClientRect();
            trackHeight = rect.height;
            knobBounds = { minY: 0, maxY: trackHeight };
            buildScale();
            const norm = (CONFIG.defaultTemp - CONFIG.minTemp) / (CONFIG.maxTemp - CONFIG.minTemp);
            const startY = trackHeight * (1 - norm);
            gsap.set(els.knob, { y: startY });
            updateSystemFromY(startY);
        }

        function initDrag(){
            Draggable.create(els.knob,{
                type: "y",
                bounds: { minY: 36, maxY: trackHeight + 36 },
                inertia: true,
                onDrag() { updateSystemFromY(this.y); },
                onThrowUpdate() { updateSystemFromY(this.y); }
            });
        }

        const minSnowSpawnInterval = 1.2;
        const maxSnowSpawnInterval = 5; 
        const minSnowFallDuration = 4;
        const maxSnowFallDuration = 7;

        function createSnowParticle() {
            const p = document.createElement("div");
            p.className = "particle";
            els.uiParticles.appendChild(p);
            
            const vw = window.innerWidth, vh = window.innerHeight;
            const size = Math.random() * 8 + 4;
            const baseOpacity = 0.85 + Math.random() * 0.15;
            const blurVal = Math.random() * 1.2 + 0.8;
            const glowColor = `rgba(${Math.random() * 50 + 200}, ${Math.random() * 50 + 200}, 255, ${baseOpacity})`;
            
            p.style.width = p.style.height = size + "px";
            p.style.borderRadius = "50%";
            p.style.background = `radial-gradient(circle, ${glowColor} 0%, rgba(100,150,255,${baseOpacity*0.6}) 70%, transparent 100%)`;
            p.style.filter = `blur(${blurVal}px)`;
            p.style.boxShadow = `0 0 20px ${glowColor}`;
            
            const startX = Math.random() * vw;
            const startY = -50 - Math.random() * 150;
            
            gsap.set(p, { x: startX, y: startY, opacity: 0, scale: 0.6 });
            
            const swayX = 60 + Math.random() * 40;
            const fallDuration = getSnowFallDuration(currentTemp);
            
            gsap.timeline({ onComplete: () => p.remove() })
                .to(p, { opacity: 1, scale: 1, duration: 0.7, ease: "power2.out" })
                .to(p, { 
                    y: vh + 80, 
                    x: "+=" + (Math.random() * swayX - swayX/2), 
                    rotation: Math.random() * 360,
                    opacity: 0, 
                    duration: fallDuration, 
                    ease: "none"
                }, 0)
                .to(p, { 
                    x: "+=" + (Math.random() * 30 - 15), 
                    yoyo: true, 
                    repeat: 1, 
                    duration: 2 + Math.random() * 2, 
                    ease: "sine.inOut" 
                }, 0.2);
        }

        function getSnowFallDuration(temp) {
            const clampedTemp = Math.max(40, Math.min(temp, 110));
            const requiredPct = (clampedTemp - 40) / 70;
            return lerp(maxSnowFallDuration * 0.55, maxSnowFallDuration, requiredPct);
        }

        function getSnowSpawnInterval(temp) {
            const clampedTemp = Math.max(40, Math.min(temp, 110));
            const requiredPct = (clampedTemp - 40) / 70;
            return lerp(maxSnowSpawnInterval * 0.45, maxSnowSpawnInterval, 1 - requiredPct);
        }

        function updateSnowParticles(temp) {
            if (temp < CONFIG.thresholds.neural) {
                if (snowParticleIntervalId !== null) {
                    clearInterval(snowParticleIntervalId);
                    snowParticleIntervalId = null;
                }
                els.uiParticles.innerHTML = "";
                return;
            }

            if (snowParticleIntervalId !== null) clearInterval(snowParticleIntervalId);

            createSnowParticle();

            const spawnInterval = getSnowSpawnInterval(temp) * 100;
            snowParticleIntervalId = setInterval(() => {
                createSnowParticle();
            }, spawnInterval);
        }

        window.addEventListener("load", () => {
            if (els.track && els.knob) {
                colorMap = createColorMap();
                initLayout();
                initDrag();
                updateSnowParticles(currentTemp);
            }
        });

        window.addEventListener("resize", () => {
            if (els.track && els.knob) {
                initLayout();
                updateSnowParticles(currentTemp);
            }
        });
    </script>
{% endblock %}
