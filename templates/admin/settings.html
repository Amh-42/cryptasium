{% extends "admin/base.html" %}

{% block title %}Settings | Cryptasium{% endblock %}
{% block page_title %}Gamification Settings{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        max-width: 700px;
    }

    .settings-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
    }

    .settings-section-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .settings-section-title i {
        color: var(--accent);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .form-row .form-group {
        margin-bottom: 0;
    }

    label {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .help-text {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 6px;
    }

    .settings-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border);
        border-radius: 10px;
        margin-bottom: 12px;
    }

    .settings-toggle:last-child {
        margin-bottom: 0;
    }

    .toggle-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .toggle-label {
        font-weight: 500;
        font-size: 14px;
    }

    .toggle-description {
        font-size: 12px;
        color: var(--text-muted);
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 28px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 28px;
        transition: 0.3s;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    .toggle-switch input:checked+.toggle-slider {
        background: var(--accent);
    }

    .toggle-switch input:checked+.toggle-slider:before {
        transform: translateX(22px);
    }

    .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
    }

    .icon-preview {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-top: 8px;
    }

    .icon-preview i {
        font-size: 20px;
        color: var(--accent);
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <form method="post">
        <!-- Appearance Settings -->
        <div class="settings-section">
            <h3 class="settings-section-title">
                <i class="ph ph-palette"></i> Appearance
            </h3>

            <div class="form-group">
                <label><i class="ph ph-paint-bucket"></i> Accent Color</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div style="position: relative; width: 50px; height: 50px; border-radius: 10px; border: 2px solid var(--border); overflow: hidden; cursor: pointer;"
                        id="accentPreview">
                        <input type="color" name="accent_color" id="accentColorInput"
                            value="{{ settings.accent_color if settings.accent_color else '#e90e0e' }}"
                            style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                    </div>
                    <div>
                        <input type="text" id="accentColorText"
                            value="{{ settings.accent_color if settings.accent_color else '#e90e0e' }}"
                            style="width: 100px;" readonly>
                        <div class="help-text">Primary color for buttons and highlights</div>
                    </div>
                </div>

                <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                    {% set preset_colors = ['#e90e0e', '#dc2626', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#0ea5e9',
                    '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#ec4899'] %}
                    {% for color in preset_colors %}
                    <button type="button" class="color-preset" data-color="{{ color }}"
                        style="width: 32px; height: 32px; border-radius: 8px; border: 2px solid transparent; background: {{ color }}; cursor: pointer;"
                        onclick="setAccentColor('{{ color }}')"></button>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Points Settings -->
        <div class="settings-section">
            <h3 class="settings-section-title">
                <i class="ph ph-lightning"></i> Points System
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label><i class="ph ph-text-aa"></i> Points Name</label>
                    <input type="text" name="points_name" value="{{ settings.points_name }}"
                        placeholder="XP, Points, Coins, etc.">
                    <div class="help-text">What to call your points</div>
                </div>

                <div class="form-group">
                    <label><i class="ph ph-shapes"></i> Points Icon</label>
                    <input type="text" name="points_icon" value="{{ settings.points_icon }}" placeholder="ph-lightning">
                    <div class="icon-preview">
                        <i class="{{ settings.points_icon }}"></i>
                        <span>{{ settings.points_name }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Goals Settings -->
        <div class="settings-section">
            <h3 class="settings-section-title">
                <i class="ph ph-target"></i> Goals & Streaks
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label><i class="ph ph-calendar-check"></i> Daily {{ points_name }} Goal</label>
                    <input type="number" name="daily_xp_goal" value="{{ settings.daily_xp_goal }}" min="0">
                    <div class="help-text">{{ points_name }} needed to complete daily goal</div>
                </div>

                <div class="form-group">
                    <label><i class="ph ph-fire"></i> Streak Bonus (per day)</label>
                    <input type="number" name="streak_bonus_per_day" value="{{ settings.streak_bonus_per_day }}"
                        min="0">
                    <div class="help-text">Extra {{ points_name }} per streak day</div>
                </div>
            </div>
        </div>

        <!-- Bonuses -->
        <div class="settings-section">
            <h3 class="settings-section-title">
                <i class="ph ph-gift"></i> Bonuses
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label><i class="ph ph-star"></i> Perfect Day Bonus</label>
                    <input type="number" name="perfect_day_bonus" value="{{ settings.perfect_day_bonus }}" min="0">
                    <div class="help-text">Bonus {{ points_name }} for completing daily goal</div>
                </div>

                <div class="form-group">
                    <label><i class="ph ph-trophy"></i> Perfect Week Bonus</label>
                    <input type="number" name="perfect_week_bonus" value="{{ settings.perfect_week_bonus }}" min="0">
                    <div class="help-text">Bonus {{ points_name }} for 7 consecutive days</div>
                </div>
            </div>
        </div>

        <!-- Display Preferences -->
        <div class="settings-section">
            <h3 class="settings-section-title">
                <i class="ph ph-eye"></i> Display Preferences
            </h3>

            <div class="settings-toggle">
                <div class="toggle-info">
                    <div class="toggle-label">{{ points_name }} Animations</div>
                    <div class="toggle-description">Show animated popups when earning {{ points_name }}</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="show_xp_animations" {% if settings.show_xp_animations %}checked{% endif
                        %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="settings-toggle">
                <div class="toggle-info">
                    <div class="toggle-label">YouTube Sync</div>
                    <div class="toggle-description">Enable automatic syncing of YouTube stats and XP (off by default)
                    </div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="enable_youtube_sync" {% if settings.enable_youtube_sync %}checked{%
                        endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="settings-toggle">
                <div class="toggle-info">
                    <div class="toggle-label">Show Gallery Header</div>
                    <div class="toggle-description">Enable the customizable top gallery on dashboard</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="show_dashboard_header" {% if settings.show_dashboard_header %}checked{%
                        endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="settings-toggle">
                <div class="toggle-info">
                    <div class="toggle-label">Always Show Confetti</div>
                    <div class="toggle-description">Keep the confetti animation active at all times</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="always_show_confetti" {% if settings.always_show_confetti %}checked{%
                        endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="form-actions" style="margin-bottom: 32px;">
            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 14px;">
                <i class="ph ph-check"></i> Save Visual Settings
            </button>
        </div>
    </form>

    <!-- Backup & Portability -->
    <div class="settings-section">
        <div class="settings-section-title">
            <i class="ph ph-archive"></i> Backup & Portability
        </div>
        <p class="help-text" style="margin-bottom: 20px;">
            Export your settings, trackables, and rank configurations to a backup file.
            You can import this file later to restore your target configuration.
        </p>

        <div class="form-row" style="grid-template-columns: 1fr 1.2fr; gap: 20px;">
            <div class="form-group">
                <label>Export Current Settings</label>
                <a href="{{ url_for('admin_export_settings') }}" class="btn btn-outline"
                    style="width: 100%; display: flex; justify-content: center; gap: 8px; padding: 12px;">
                    <i class="ph ph-download-simple"></i> Download .cryptasium
                </a>
            </div>

            <form action="{{ url_for('admin_import_settings') }}" method="post" enctype="multipart/form-data"
                class="form-group">
                <label>Import Settings</label>
                <div style="display: flex; gap: 8px; align-items: stretch;">
                    <label class="custom-file-upload" style="flex: 1;">
                        <i class="ph ph-file-plus"></i>
                        <span class="file-name-display">Choose file...</span>
                        <input type="file" name="backup_file" accept=".cryptasium,.json" required
                            onchange="updateFileName(this)">
                    </label>
                    <button type="submit" class="btn btn-primary" style="padding: 0 20px; flex-shrink: 0;">
                        <i class="ph ph-upload-simple"></i> Import
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Security -->
    <div class="settings-section">
        <div class="settings-section-title">
            <i class="ph ph-shield-check"></i> Account Security
        </div>
        <form action="{{ url_for('admin_reset_password') }}" method="post">
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" name="current_password" required placeholder="Enter your current password">
            </div>
            <div class="form-row" style="margin-top: 20px;">
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" name="new_password" required minlength="6"
                        placeholder="At least 6 characters">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" name="confirm_password" required minlength="6"
                        placeholder="Repeat new password">
                </div>
            </div>
            <div class="form-actions" style="margin-top: 24px;">
                <button type="submit" class="btn btn-primary">
                    <i class="ph ph-lock-key"></i> Update Password
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Accent color picker
    const accentInput = document.getElementById('accentColorInput');
    const accentPreview = document.getElementById('accentPreview');
    const accentText = document.getElementById('accentColorText');

    if (accentInput) {
        accentPreview.style.background = accentInput.value;

        accentInput.addEventListener('input', function () {
            accentPreview.style.background = this.value;
            accentText.value = this.value;
            updateAccentPreview(this.value);
        });
    }

    function setAccentColor(color) {
        accentInput.value = color;
        accentPreview.style.background = color;
        accentText.value = color;
        updateAccentPreview(color);
    }

    function updateAccentPreview(color) {
        document.documentElement.style.setProperty('--accent', color);
    }

    function updateFileName(input) {
        const display = input.parentElement.querySelector('.file-name-display');
        if (input.files && input.files[0]) {
            display.textContent = input.files[0].name;
            display.style.color = 'var(--text-main)';
        } else {
            display.textContent = 'Choose file...';
            display.style.color = 'var(--text-muted)';
        }
    }
</script>
{% endblock %}