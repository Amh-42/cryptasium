{% extends "admin/base.html" %}

{% block title %}Topic Ideas | Admin{% endblock %}

{% block page_title %}Topic Ideas{% endblock %}

{% block extra_css %}
<style>
    .action-btn.approve { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .action-btn.reject { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .action-btn.pending { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    
    .mobile-card-actions {
        display: flex;
        gap: 8px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
    }
    
    .mobile-card-actions .action-btn {
        width: 36px;
        height: 36px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Topic Ideas</h1>
        <p style="color: var(--text-muted); font-size: 14px; margin-top: 4px;">Community submitted topic suggestions</p>
    </div>
    <div class="page-actions">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline">
            <i class="ph ph-arrow-left"></i>
            Dashboard
        </a>
    </div>
</div>

<div class="filament-table-container">
    <div class="table-header">
        <div class="table-search">
            <i class="ph ph-magnifying-glass"></i>
            <input type="text" id="searchInput" placeholder="Search ideas..." onkeyup="filterTable()">
        </div>
        <div class="table-filters">
            <button class="filter-btn active" data-filter="all" onclick="filterByStatus('all')">
                <i class="ph ph-list"></i>
                All
            </button>
            <button class="filter-btn" data-filter="pending" onclick="filterByStatus('pending')">
                <i class="ph ph-clock"></i>
                Pending
            </button>
            <button class="filter-btn" data-filter="approved" onclick="filterByStatus('approved')">
                <i class="ph ph-check-circle"></i>
                Approved
            </button>
            <button class="filter-btn" data-filter="rejected" onclick="filterByStatus('rejected')">
                <i class="ph ph-x-circle"></i>
                Rejected
            </button>
        </div>
    </div>

    <div class="table-wrapper">
        <table class="filament-table">
            <thead>
                <tr>
                    <th class="sortable" onclick="sortTable(0)">
                        Topic
                        <i class="ph ph-arrows-down-up"></i>
                    </th>
                    <th class="sortable" onclick="sortTable(1)">
                        Status
                        <i class="ph ph-arrows-down-up"></i>
                    </th>
                    <th class="hide-mobile">Submitted By</th>
                    <th class="sortable hide-mobile" onclick="sortTable(2)">
                        Date
                        <i class="ph ph-arrows-down-up"></i>
                    </th>
                    <th style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for idea in ideas %}
                <tr data-status="{{ idea.status or 'pending' }}" data-title="{{ idea.topic|lower }}">
                    <td>
                        <div style="font-weight: 500; margin-bottom: 4px;">{{ idea.topic }}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">{{ idea.description[:80] if idea.description else 'No description' }}...</div>
                    </td>
                    <td>
                        <span class="status-badge {% if idea.status == 'approved' %}published{% elif idea.status == 'rejected' %}draft{% else %}pending{% endif %}">
                            <i class="ph ph-{% if idea.status == 'approved' %}check-circle{% elif idea.status == 'rejected' %}x-circle{% else %}clock{% endif %}"></i>
                            {{ idea.status|capitalize if idea.status else 'Pending' }}
                        </span>
                    </td>
                    <td class="hide-mobile">
                        <div style="font-size: 13px;">{{ idea.name or 'Anonymous' }}</div>
                        {% if idea.email %}
                        <div style="font-size: 11px; color: var(--text-muted);">{{ idea.email }}</div>
                        {% endif %}
                    </td>
                    <td class="hide-mobile">
                        <div style="font-size: 13px;">{{ idea.created_at.strftime('%b %d, %Y') if idea.created_at else 'N/A' }}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">{{ idea.created_at.strftime('%I:%M %p') if idea.created_at else '' }}</div>
                    </td>
                    <td>
                        <div class="action-buttons" style="justify-content: flex-end;">
                            {% if idea.status != 'approved' %}
                            <form method="POST" action="{{ url_for('admin_ideas_approve', id=idea.id) }}" style="display: inline;">
                                <button type="submit" class="action-btn approve" title="Approve">
                                    <i class="ph ph-check"></i>
                                </button>
                            </form>
                            {% endif %}
                            {% if idea.status != 'rejected' %}
                            <form method="POST" action="{{ url_for('admin_ideas_reject', id=idea.id) }}" style="display: inline;">
                                <button type="submit" class="action-btn reject" title="Reject">
                                    <i class="ph ph-x"></i>
                                </button>
                            </form>
                            {% endif %}
                            {% if idea.status in ['approved', 'rejected'] %}
                            <form method="POST" action="{{ url_for('admin_ideas_pending', id=idea.id) }}" style="display: inline;">
                                <button type="submit" class="action-btn pending" title="Set Pending">
                                    <i class="ph ph-clock"></i>
                                </button>
                            </form>
                            {% endif %}
                            <form method="POST" action="{{ url_for('admin_ideas_delete', id=idea.id) }}" style="display: inline;" onsubmit="return confirmDelete(this, 'Idea')">
                                <button type="submit" class="action-btn delete" title="Delete">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5">
                        <div class="empty-state">
                            <i class="ph ph-lightbulb"></i>
                            <h3>No topic ideas found</h3>
                            <p>No one has submitted topic ideas yet.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Cards View -->
    <div class="mobile-cards-wrapper" id="mobileCardsBody">
        {% for idea in ideas %}
        <div class="mobile-card" data-status="{{ idea.status or 'pending' }}" data-title="{{ idea.topic|lower }}">
            <div class="mobile-card-header">
                <div class="mobile-card-info">
                    <div class="mobile-card-title">{{ idea.topic }}</div>
                    <div class="mobile-card-meta">
                        <span>
                            <i class="ph ph-user"></i>
                            {{ idea.name or 'Anonymous' }}
                        </span>
                        <span>
                            <i class="ph ph-calendar"></i>
                            {{ idea.created_at.strftime('%b %d') if idea.created_at else 'N/A' }}
                        </span>
                    </div>
                </div>
                <span class="status-badge {% if idea.status == 'approved' %}published{% elif idea.status == 'rejected' %}draft{% else %}pending{% endif %}">
                    {{ idea.status|capitalize if idea.status else 'Pending' }}
                </span>
            </div>
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px; line-height: 1.4;">
                {{ idea.description[:120] if idea.description else 'No description' }}{% if idea.description and idea.description|length > 120 %}...{% endif %}
            </div>
            <div class="mobile-card-actions">
                {% if idea.status != 'approved' %}
                <form method="POST" action="{{ url_for('admin_ideas_approve', id=idea.id) }}" style="display: inline;">
                    <button type="submit" class="action-btn approve" title="Approve">
                        <i class="ph ph-check"></i>
                    </button>
                </form>
                {% endif %}
                {% if idea.status != 'rejected' %}
                <form method="POST" action="{{ url_for('admin_ideas_reject', id=idea.id) }}" style="display: inline;">
                    <button type="submit" class="action-btn reject" title="Reject">
                        <i class="ph ph-x"></i>
                    </button>
                </form>
                {% endif %}
                {% if idea.status in ['approved', 'rejected'] %}
                <form method="POST" action="{{ url_for('admin_ideas_pending', id=idea.id) }}" style="display: inline;">
                    <button type="submit" class="action-btn pending" title="Set Pending">
                        <i class="ph ph-clock"></i>
                    </button>
                </form>
                {% endif %}
                <form method="POST" action="{{ url_for('admin_ideas_delete', id=idea.id) }}" style="display: inline;" onsubmit="return confirmDelete(this, 'Idea')">
                    <button type="submit" class="action-btn delete" title="Delete">
                        <i class="ph ph-trash"></i>
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="ph ph-lightbulb"></i>
            <h3>No topic ideas found</h3>
            <p>No one has submitted topic ideas yet.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentFilter = 'all';
    let sortDirection = {};

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        
        // Filter table rows
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            const title = row.getAttribute('data-title') || '';
            const matchesSearch = title.includes(filter);
            const matchesStatus = currentFilter === 'all' || row.getAttribute('data-status') === currentFilter;
            
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
        
        // Filter mobile cards
        const cards = document.querySelectorAll('#mobileCardsBody .mobile-card');
        cards.forEach(card => {
            const title = card.getAttribute('data-title') || '';
            const matchesSearch = title.includes(filter);
            const matchesStatus = currentFilter === 'all' || card.getAttribute('data-status') === currentFilter;
            
            card.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }

    function filterByStatus(status) {
        currentFilter = status;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-filter') === status);
        });
        filterTable();
    }

    function sortTable(columnIndex) {
        const table = document.querySelector('.filament-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
        
        if (!sortDirection[columnIndex]) {
            sortDirection[columnIndex] = 'asc';
        } else {
            sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
        }

        rows.sort((a, b) => {
            let aVal, bVal;
            
            switch(columnIndex) {
                case 0:
                    aVal = a.getAttribute('data-title') || '';
                    bVal = b.getAttribute('data-title') || '';
                    break;
                case 1:
                    aVal = a.getAttribute('data-status') || '';
                    bVal = b.getAttribute('data-status') || '';
                    break;
                case 2:
                    aVal = a.cells[3].textContent.trim();
                    bVal = b.cells[3].textContent.trim();
                    break;
                default:
                    return 0;
            }

            if (sortDirection[columnIndex] === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        rows.forEach(row => tbody.appendChild(row));
    }
</script>
{% endblock %}
