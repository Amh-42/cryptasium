{% extends "admin/base.html" %}

{% block title %}Content Calendar | Cryptasium Admin{% endblock %}

{% block page_title %}Content Calendar{% endblock %}

{% block extra_css %}
<style>
    /* ========== CALENDAR STYLES ========== */
    .calendar-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
    }

    .calendar-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
        gap: 12px;
    }

    .calendar-nav {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .nav-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .nav-btn:hover {
        background: var(--accent);
        border-color: var(--accent);
    }

    .today-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-main);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .today-btn:hover {
        background: var(--accent);
        border-color: var(--accent);
    }

    .today-btn.active {
        background: rgba(14, 165, 233, 0.2);
        border-color: var(--accent);
        color: var(--accent);
    }

    .calendar-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-main);
        min-width: 200px;
    }

    .toolbar-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .view-switcher {
        display: flex;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 4px;
        gap: 4px;
    }

    .view-btn {
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .view-btn:hover {
        color: var(--text-main);
    }

    .view-btn.active {
        background: var(--accent);
        color: white;
    }

    .plan-btn {
        padding: 10px 18px;
        background: linear-gradient(135deg, #a855f7, #6366f1);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
    }

    .plan-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
    }

    .add-btn {
        padding: 10px 18px;
        background: var(--accent);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
    }

    .add-btn:hover {
        background: var(--accent-hover);
    }

    /* Schedule Legend */
    .schedule-legend {
        padding: 12px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        background: rgba(255, 255, 255, 0.02);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-muted);
    }

    .legend-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    /* ========== WEEK VIEW ========== */
    .week-view {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
    }

    .week-header {
        display: contents;
    }

    .week-header-cell {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid var(--border);
        border-right: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
    }

    .week-header-cell:last-child {
        border-right: none;
    }

    .header-day {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .header-date {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-main);
        margin-top: 4px;
    }

    .header-date.is-today {
        width: 32px;
        height: 32px;
        background: var(--accent);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .week-body {
        display: contents;
    }

    .day-cell {
        min-height: 140px;
        padding: 8px;
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 6px;
        transition: background 0.2s;
    }

    .day-cell:last-child {
        border-right: none;
    }

    .day-cell:nth-last-child(-n+7) {
        border-bottom: none;
    }

    .day-cell.is-today {
        background: rgba(14, 165, 233, 0.05);
    }

    .day-cell.drag-over {
        background: rgba(14, 165, 233, 0.15);
        outline: 2px dashed var(--accent);
        outline-offset: -2px;
    }

    .scheduled-tag {
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .scheduled-tag:hover {
        opacity: 1 !important;
    }

    .scheduled-tag.has-title {
        opacity: 1;
        font-weight: 500;
    }

    .scheduled-tag .tag-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
    }

    /* ========== MONTH VIEW ========== */
    .month-view {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
    }

    .month-header-cell {
        padding: 10px;
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
    }

    .month-day-cell {
        min-height: 90px;
        padding: 8px;
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        position: relative;
        transition: background 0.2s;
    }

    .month-day-cell:nth-child(7n) {
        border-right: none;
    }

    .month-day-cell.other-month {
        opacity: 0.3;
    }

    .month-day-cell.is-today {
        background: rgba(14, 165, 233, 0.05);
    }

    .month-day-cell.drag-over {
        background: rgba(14, 165, 233, 0.15);
        outline: 2px dashed var(--accent);
        outline-offset: -2px;
    }

    .month-day-number {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-main);
        margin-bottom: 6px;
    }

    .month-day-cell.is-today .month-day-number {
        width: 24px;
        height: 24px;
        background: var(--accent);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    /* ========== DAY VIEW ========== */
    .day-view {
        padding: 20px;
    }

    .day-view-header {
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
    }

    .day-view-date {
        font-size: 48px;
        font-weight: 700;
        color: var(--text-main);
    }

    .day-view-weekday {
        font-size: 18px;
        color: var(--text-muted);
        margin-top: 8px;
    }

    .day-schedule {
        max-width: 600px;
        margin: 0 auto;
    }

    .time-slot {
        display: flex;
        gap: 16px;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
    }

    .time-label {
        width: 60px;
        font-size: 12px;
        color: var(--text-muted);
        text-align: right;
        padding-top: 4px;
    }

    .slot-content {
        flex: 1;
    }

    /* ========== SCHEDULE VIEW ========== */
    .schedule-view {
        padding: 20px;
    }

    .schedule-section {
        margin-bottom: 32px;
    }

    .schedule-section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .schedule-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .schedule-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 10px;
        transition: all 0.2s;
        border-left: 3px solid var(--item-color, var(--accent));
    }

    .schedule-item:hover {
        border-color: var(--accent);
        background: rgba(255, 255, 255, 0.05);
    }
    
    .schedule-item[data-entry-id] {
        cursor: pointer;
    }
    
    .schedule-item[data-entry-id]:hover {
        transform: translateX(4px);
    }

    .schedule-item-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .schedule-item-content {
        flex: 1;
    }

    .schedule-item-title {
        font-size: 15px;
        font-weight: 500;
        color: var(--text-main);
    }

    .schedule-item-meta {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
        display: flex;
        gap: 12px;
    }

    .schedule-item-time {
        font-size: 13px;
        color: var(--text-muted);
    }

    .schedule-item-badge {
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-muted);
    }

    .schedule-item-badge.planned {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }

    /* ========== ENTRY CARD ========== */
    .entry-card {
        padding: 8px 10px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid var(--entry-color, var(--accent));
        background: rgba(255, 255, 255, 0.03);
    }

    .entry-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateX(2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .entry-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }
    
    .entry-card[data-entry-id] {
        cursor: pointer;
    }

    .entry-card.completed {
        opacity: 0.5;
        text-decoration: line-through;
    }

    .entry-title {
        font-weight: 500;
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .entry-time {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 2px;
    }

    .add-entry-btn {
        padding: 6px;
        border: 1px dashed var(--border);
        border-radius: 6px;
        text-align: center;
        font-size: 11px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
        margin-top: auto;
    }

    .add-entry-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
    }

    /* ========== MODAL ========== */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-content.wide {
        max-width: 600px;
    }

    .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .modal-close {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        background: #ef4444;
        color: white;
    }

    .modal-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-main);
        font-size: 14px;
        font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--accent);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .plan-item {
        padding: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 10px;
        margin-bottom: 12px;
        border-left: 3px solid var(--item-color, var(--accent));
    }

    .plan-item-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .plan-item-icon {
        font-size: 18px;
    }

    .plan-item-label {
        font-weight: 500;
        color: var(--text-main);
    }

    .plan-item-day {
        font-size: 11px;
        color: var(--text-muted);
        margin-left: auto;
    }

    .color-picker {
        display: flex;
        gap: 6px;
    }

    .color-dot {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }

    .color-dot:hover,
    .color-dot.selected {
        transform: scale(1.1);
        border-color: white;
    }

    .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn-cancel {
        padding: 8px 16px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-muted);
        cursor: pointer;
    }

    .btn-cancel:hover {
        border-color: var(--text-muted);
    }

    .btn-submit {
        padding: 8px 16px;
        background: var(--accent);
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        cursor: pointer;
    }

    .btn-submit:hover {
        background: var(--accent-hover);
    }

    .btn-submit.gradient {
        background: linear-gradient(135deg, #a855f7, #6366f1);
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 900px) {
        .week-view {
            grid-template-columns: repeat(4, 1fr);
        }
        .week-header-cell:nth-child(n+5),
        .day-cell:nth-child(n+5) {
            display: none;
        }
    }

    @media (max-width: 600px) {
        .week-view, .month-view {
            display: none;
        }
        .schedule-view {
            display: block !important;
        }
        .view-switcher {
            display: none;
        }
        .calendar-toolbar {
            flex-direction: column;
        }
        .toolbar-actions {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- Toolbar -->
    <div class="calendar-toolbar">
        <div class="calendar-nav">
            <button class="nav-btn" onclick="navigatePrev()" title="Previous">
                <i class="ph ph-caret-left"></i>
            </button>
            <button class="today-btn {% if selected_date == today %}active{% endif %}" onclick="goToToday()">Today</button>
            <button class="nav-btn" onclick="navigateNext()" title="Next">
                <i class="ph ph-caret-right"></i>
            </button>
            <span class="calendar-title" id="calendarTitle">
                <span class="week-title">{{ start_of_week.strftime('%b %d') }} - {{ end_of_week.strftime('%b %d, %Y') }}</span>
                <span class="month-title" style="display: none;">{{ current_month_name }}</span>
            </span>
        </div>

        <div class="toolbar-actions">
            <div class="view-switcher">
                <button class="view-btn" data-view="day" onclick="switchView('day')">Day</button>
                <button class="view-btn active" data-view="week" onclick="switchView('week')">Week</button>
                <button class="view-btn" data-view="month" onclick="switchView('month')">Month</button>
                <button class="view-btn" data-view="schedule" onclick="switchView('schedule')">List</button>
            </div>
            
            <button class="plan-btn" onclick="openPlanModal()">
                <i class="ph ph-calendar-plus"></i>
                Plan Week
            </button>
            
            <button class="add-btn" onclick="openAddModal()">
                <i class="ph ph-plus"></i>
                Add
            </button>
        </div>
    </div>

    <!-- Legend -->
    <div class="schedule-legend">
        <span style="font-size: 11px; color: var(--text-muted); margin-right: 8px;">Weekly Schedule:</span>
        {% for schedule in posting_schedule %}
        <div class="legend-item">
            <span class="legend-dot" style="background: {{ schedule.color }};"></span>
            <span>{{ schedule.content_label.split(' ')[0] }} - {{ schedule.day_name[:3] }}</span>
        </div>
        {% endfor %}
    </div>

    <!-- Week View (Default) -->
    <div class="week-view" id="weekView">
        <div class="week-header">
            {% for day in week_days %}
            <div class="week-header-cell">
                <div class="header-day">{{ day.day_name[:3] }}</div>
                <div class="header-date {% if day.is_today %}is-today{% endif %}">{{ day.date.day }}</div>
            </div>
            {% endfor %}
        </div>
        <div class="week-body">
            {% for day in week_days %}
            <div class="day-cell {% if day.is_today %}is-today{% endif %}" 
                 data-date="{{ day.date.isoformat() }}"
                 ondragover="handleDragOver(event)"
                 ondrop="handleDrop(event)"
                 ondragleave="handleDragLeave(event)">
                
                {% if day.scheduled_type %}
                <div class="scheduled-tag {% if day.scheduled_type.planned_title %}has-title{% endif %}" 
                     style="background: {{ day.scheduled_type.color }}20; color: {{ day.scheduled_type.color }}; opacity: 0.7;"
                     title="{{ day.scheduled_type.content_label }}: {{ day.scheduled_type.planned_title or 'Not planned yet' }}">
                    <i class="{{ day.scheduled_type.icon }}" style="font-size: 12px;"></i>
                    <span class="tag-title">{{ day.scheduled_type.planned_title or day.scheduled_type.content_label }}</span>
                </div>
                {% endif %}
                
                {% for entry in day.entries %}
                <div class="entry-card {% if entry.status == 'completed' %}completed{% endif %}" 
                     style="--entry-color: {{ entry.color }};"
                     draggable="true"
                     data-entry-id="{{ entry.id }}"
                     data-title="{{ entry.title|e }}"
                     data-date="{{ entry.scheduled_date }}"
                     data-time="{{ entry.scheduled_time or '' }}"
                     data-type="{{ entry.content_type }}"
                     data-desc="{{ entry.description|e if entry.description else '' }}"
                     data-status="{{ entry.status }}"
                     data-color="{{ entry.color }}"
                     data-notes="{{ entry.notes|e if entry.notes else '' }}"
                     ondragstart="handleDragStart(event)"
                     ondragend="handleDragEnd(event)">
                    <div class="entry-title">{{ entry.title }}</div>
                    {% if entry.scheduled_time %}
                    <div class="entry-time">{{ entry.scheduled_time }}</div>
                    {% endif %}
                </div>
                {% endfor %}
                
                <div class="add-entry-btn" onclick="openAddModal('{{ day.date.isoformat() }}')">
                    <i class="ph ph-plus"></i>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Month View -->
    <div class="month-view" id="monthView" style="display: none;">
        {% set days_of_week = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
        {% for day_name in days_of_week %}
        <div class="month-header-cell">{{ day_name }}</div>
        {% endfor %}
        
        {% for day in month_days %}
        <div class="month-day-cell {% if day.is_other_month %}other-month{% endif %} {% if day.is_today %}is-today{% endif %}" 
             data-date="{{ day.date.isoformat() }}"
             ondragover="handleDragOver(event)"
             ondrop="handleDrop(event)"
             ondragleave="handleDragLeave(event)">
            <div class="month-day-number">{{ day.date.day }}</div>
            {% for entry in day.entries[:3] %}
            <div class="entry-card" 
                 style="--entry-color: {{ entry.color }}; font-size: 10px; padding: 4px 6px; margin-bottom: 4px;"
                 draggable="true"
                 data-entry-id="{{ entry.id }}"
                 data-title="{{ entry.title|e }}"
                 data-date="{{ entry.scheduled_date }}"
                 data-time="{{ entry.scheduled_time or '' }}"
                 data-type="{{ entry.content_type }}"
                 data-desc="{{ entry.description|e if entry.description else '' }}"
                 data-status="{{ entry.status }}"
                 data-color="{{ entry.color }}"
                 data-notes="{{ entry.notes|e if entry.notes else '' }}"
                 ondragstart="handleDragStart(event)"
                 ondragend="handleDragEnd(event)">
                {{ entry.title[:12] }}{% if entry.title|length > 12 %}...{% endif %}
            </div>
            {% endfor %}
            {% if day.entries|length > 3 %}
            <div style="font-size: 10px; color: var(--text-muted);">+{{ day.entries|length - 3 }} more</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Day View -->
    <div class="day-view" id="dayView" style="display: none;">
        <div class="day-view-header">
            <div class="day-view-date">{{ selected_date.day }}</div>
            <div class="day-view-weekday">{{ selected_date.strftime('%A, %B %d, %Y') }}</div>
        </div>
        <div class="day-schedule" id="dayScheduleContent">
            {# Use selected_day_entries passed directly from route #}
            {% if selected_day_entries and selected_day_entries|length > 0 %}
                {% for entry in selected_day_entries %}
                <div class="time-slot">
                    <div class="time-label">{{ entry.scheduled_time or 'All day' }}</div>
                    <div class="slot-content">
                        <div class="entry-card {% if entry.status == 'completed' %}completed{% endif %}" 
                             style="--entry-color: {{ entry.color }};"
                             data-entry-id="{{ entry.id }}"
                             data-title="{{ entry.title|e }}"
                             data-date="{{ entry.scheduled_date }}"
                             data-time="{{ entry.scheduled_time or '' }}"
                             data-type="{{ entry.content_type }}"
                             data-desc="{{ entry.description|e if entry.description else '' }}"
                             data-status="{{ entry.status }}"
                             data-color="{{ entry.color }}"
                             data-notes="{{ entry.notes|e if entry.notes else '' }}">
                            <div class="entry-title">{{ entry.title }}</div>
                            <div class="entry-time">{{ entry.content_type }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="ph ph-calendar-blank"></i>
                    <p>No content scheduled for {{ selected_date.strftime('%B %d') }}</p>
                    <button class="add-btn" onclick="openAddModal('{{ selected_date.isoformat() }}')" style="margin: 16px auto 0;">
                        <i class="ph ph-plus"></i> Add Entry
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Schedule/List View -->
    <div class="schedule-view" id="scheduleView" style="display: none;">
        <div class="schedule-section">
            <div class="schedule-section-title">
                <i class="ph ph-calendar-check"></i>
                This Week's Content Plan
            </div>
            <div class="schedule-list">
                {% for schedule in posting_schedule %}
                <div class="schedule-item" style="--item-color: {{ schedule.color }};">
                    <div class="schedule-item-icon" style="color: {{ schedule.color }};">
                        <i class="{{ schedule.icon }}"></i>
                    </div>
                    <div class="schedule-item-content">
                        <div class="schedule-item-title">
                            {% if schedule.planned_title %}
                                {{ schedule.planned_title }}
                            {% else %}
                                <span style="opacity: 0.5;">{{ schedule.content_label }} - Not planned</span>
                            {% endif %}
                        </div>
                        <div class="schedule-item-meta">
                            <span>{{ schedule.day_name }}</span>
                            <span>{{ schedule.preferred_time or 'Flexible' }}</span>
                        </div>
                    </div>
                    {% if schedule.planned_title %}
                    <span class="schedule-item-badge planned">Planned</span>
                    {% else %}
                    <span class="schedule-item-badge">Pending</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="schedule-section">
            <div class="schedule-section-title">
                <i class="ph ph-list-checks"></i>
                All Entries This Week
            </div>
            <div class="schedule-list">
                {% set all_entries = [] %}
                {% for day in week_days %}
                    {% for entry in day.entries %}
                        {% set _ = all_entries.append({'date': day.date, 'day_name': day.day_name, 'entry': entry}) %}
                    {% endfor %}
                {% endfor %}
                
                {% if all_entries %}
                    {% for item in all_entries %}
                    <div class="schedule-item" 
                         style="--item-color: {{ item.entry.color }};"
                         data-entry-id="{{ item.entry.id }}"
                         data-title="{{ item.entry.title|e }}"
                         data-date="{{ item.entry.scheduled_date }}"
                         data-time="{{ item.entry.scheduled_time or '' }}"
                         data-type="{{ item.entry.content_type }}"
                         data-desc="{{ item.entry.description|e if item.entry.description else '' }}"
                         data-status="{{ item.entry.status }}"
                         data-color="{{ item.entry.color }}"
                         data-notes="{{ item.entry.notes|e if item.entry.notes else '' }}">
                        <div class="schedule-item-icon">
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: 700;">{{ item.date.day }}</div>
                                <div style="font-size: 10px; color: var(--text-muted);">{{ item.date.strftime('%b') }}</div>
                            </div>
                        </div>
                        <div class="schedule-item-content">
                            <div class="schedule-item-title">{{ item.entry.title }}</div>
                            <div class="schedule-item-meta">
                                <span>{{ item.day_name }}</span>
                                <span>{{ item.entry.content_type }}</span>
                            </div>
                        </div>
                        <span class="schedule-item-time">{{ item.entry.scheduled_time or 'All day' }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state" style="padding: 20px;">
                        <p>No custom entries yet. Use "Plan Week" to set your content titles!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Plan Week Modal -->
<div class="modal-overlay" id="planModal">
    <div class="modal-content wide">
        <div class="modal-header">
            <h3><i class="ph ph-calendar-plus" style="color: #a855f7;"></i> Plan Week: {{ start_of_week.strftime('%b %d') }} - {{ end_of_week.strftime('%b %d') }}</h3>
            <button class="modal-close" onclick="closeModal('planModal')"><i class="ph ph-x"></i></button>
        </div>
        <form method="POST" action="{{ url_for('admin_calendar_plan_week') }}">
            <input type="hidden" name="week_start" value="{{ start_of_week.isoformat() }}">
            <div class="modal-body">
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">
                    Enter titles for your 5 weekly content pieces. These will be added to your calendar automatically.
                </p>
                
                {% for schedule in posting_schedule %}
                <div class="plan-item" style="--item-color: {{ schedule.color }};">
                    <div class="plan-item-header">
                        <i class="{{ schedule.icon }} plan-item-icon" style="color: {{ schedule.color }};"></i>
                        <span class="plan-item-label">{{ schedule.content_label }}</span>
                        <span class="plan-item-day">{{ schedule.day_name }} {{ schedule.preferred_time or '' }}</span>
                    </div>
                    <input type="text" 
                           name="title_{{ schedule.content_type }}" 
                           placeholder="Enter title for {{ schedule.content_label }}..."
                           value="{{ schedule.planned_title or '' }}">
                </div>
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('planModal')">Cancel</button>
                <button type="submit" class="btn-submit gradient">
                    <i class="ph ph-check"></i> Save Week Plan
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Modal -->
<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="ph ph-plus-circle"></i> New Entry</h3>
            <button class="modal-close" onclick="closeModal('addModal')"><i class="ph ph-x"></i></button>
        </div>
        <form method="POST" action="{{ url_for('admin_calendar_add_entry') }}">
            <div class="modal-body">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" name="title" required placeholder="Content title...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" name="scheduled_date" id="add_date" required>
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" name="scheduled_time">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select name="content_type">
                            <option value="youtube">YouTube</option>
                            <option value="short">Short</option>
                            <option value="blog">Blog</option>
                            <option value="podcast">Podcast</option>
                            <option value="custom" selected>Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="planned">Planned</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker">
                        <div class="color-dot selected" style="background: #0ea5e9;" data-color="#0ea5e9" onclick="selectColor(this, 'add')"></div>
                        <div class="color-dot" style="background: #ff0000;" data-color="#ff0000" onclick="selectColor(this, 'add')"></div>
                        <div class="color-dot" style="background: #a855f7;" data-color="#a855f7" onclick="selectColor(this, 'add')"></div>
                        <div class="color-dot" style="background: #22c55e;" data-color="#22c55e" onclick="selectColor(this, 'add')"></div>
                        <div class="color-dot" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this, 'add')"></div>
                    </div>
                    <input type="hidden" name="color" id="add_color" value="#0ea5e9">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" rows="2" placeholder="Optional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('addModal')">Cancel</button>
                <button type="submit" class="btn-submit">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="ph ph-pencil"></i> Edit Entry</h3>
            <button class="modal-close" onclick="closeModal('editModal')"><i class="ph ph-x"></i></button>
        </div>
        <form method="POST" action="" id="editForm">
            <div class="modal-body">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" name="title" id="edit_title" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" name="scheduled_date" id="edit_date" required>
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" name="scheduled_time" id="edit_time">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select name="content_type" id="edit_type">
                            <option value="youtube">YouTube</option>
                            <option value="short">Short</option>
                            <option value="blog">Blog</option>
                            <option value="podcast">Podcast</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" id="edit_status">
                            <option value="planned">Planned</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker" id="edit_colors">
                        <div class="color-dot" style="background: #0ea5e9;" data-color="#0ea5e9" onclick="selectColor(this, 'edit')"></div>
                        <div class="color-dot" style="background: #ff0000;" data-color="#ff0000" onclick="selectColor(this, 'edit')"></div>
                        <div class="color-dot" style="background: #a855f7;" data-color="#a855f7" onclick="selectColor(this, 'edit')"></div>
                        <div class="color-dot" style="background: #22c55e;" data-color="#22c55e" onclick="selectColor(this, 'edit')"></div>
                        <div class="color-dot" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this, 'edit')"></div>
                    </div>
                    <input type="hidden" name="color" id="edit_color" value="#0ea5e9">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" id="edit_notes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" style="color: #ef4444; border-color: #ef4444;" onclick="deleteEntry()">Delete</button>
                <button type="button" class="btn-cancel" onclick="closeModal('editModal')">Cancel</button>
                <button type="submit" class="btn-submit">Save</button>
            </div>
        </form>
        <form method="POST" id="deleteForm" style="display: none;"></form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentEntryId = null;
    let draggedEntryId = null;
    let currentView = localStorage.getItem('calendarView') || 'week';
    
    // Navigation dates from server
    const navDates = {
        prevWeek: '{{ prev_week }}',
        nextWeek: '{{ next_week }}',
        prevMonth: '{{ prev_month }}',
        nextMonth: '{{ next_month }}',
        today: '{{ today.isoformat() }}'
    };

    // ========== VIEW SWITCHING ==========
    function switchView(view) {
        currentView = view;
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        document.getElementById('weekView').style.display = view === 'week' ? 'grid' : 'none';
        document.getElementById('monthView').style.display = view === 'month' ? 'grid' : 'none';
        document.getElementById('dayView').style.display = view === 'day' ? 'block' : 'none';
        document.getElementById('scheduleView').style.display = view === 'schedule' ? 'block' : 'none';
        
        // Update title display
        document.querySelector('.week-title').style.display = (view === 'week' || view === 'day' || view === 'schedule') ? 'inline' : 'none';
        document.querySelector('.month-title').style.display = view === 'month' ? 'inline' : 'none';
        
        localStorage.setItem('calendarView', view);
    }

    // ========== NAVIGATION ==========
    function navigatePrev() {
        const targetDate = (currentView === 'month') ? navDates.prevMonth : navDates.prevWeek;
        window.location.href = `{{ url_for('admin_calendar') }}?date=${targetDate}&view=${currentView}`;
    }

    function navigateNext() {
        const targetDate = (currentView === 'month') ? navDates.nextMonth : navDates.nextWeek;
        window.location.href = `{{ url_for('admin_calendar') }}?date=${targetDate}&view=${currentView}`;
    }

    function goToToday() {
        window.location.href = `{{ url_for('admin_calendar') }}?date=${navDates.today}&view=${currentView}`;
    }

    // ========== DRAG & DROP ==========
    let isDragging = false;
    let dragStartTime = 0;
    
    function handleDragStart(e) {
        isDragging = true;
        dragStartTime = Date.now();
        draggedEntryId = e.target.dataset.entryId;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedEntryId);
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        // Reset dragging state after a short delay
        setTimeout(() => { isDragging = false; }, 100);
    }
    
    // Handle click on entry - check if it was a quick click (not a drag)
    function handleEntryClick(e, id, title, date, time, type, desc, status, color, notes) {
        // Prevent if we're in the middle of dragging
        if (isDragging && (Date.now() - dragStartTime) > 200) {
            return;
        }
        e.stopPropagation();
        openEditModal(id, title, date, time, type, desc, status, color, notes);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        
        const entryId = e.dataTransfer.getData('text/plain');
        const newDate = e.currentTarget.dataset.date;
        
        if (entryId && newDate) {
            // Use FormData instead of JSON for better Flask compatibility
            const formData = new FormData();
            formData.append('new_date', newDate);
            
            // Send AJAX request to move the entry
            fetch(`/admin/calendar/entry/${entryId}/move`, {
                method: 'POST',
                body: formData
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    // Preserve current view when reloading
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('view', currentView);
                    window.location.href = currentUrl.toString();
                } else {
                    alert('Failed to move entry: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Move error:', err);
                alert('Failed to move entry: ' + err.message);
            });
        }
    }

    // ========== MODALS ==========
    function openPlanModal() {
        document.getElementById('planModal').classList.add('active');
    }

    function openAddModal(date) {
        document.getElementById('addModal').classList.add('active');
        document.getElementById('add_date').value = date || '{{ today.isoformat() }}';
    }

    function openEditModal(id, title, date, time, type, desc, status, color, notes) {
        currentEntryId = id;
        document.getElementById('editModal').classList.add('active');
        document.getElementById('editForm').action = '/admin/calendar/entry/' + id + '/update';
        document.getElementById('deleteForm').action = '/admin/calendar/entry/' + id + '/delete';
        document.getElementById('edit_title').value = title;
        document.getElementById('edit_date').value = date;
        document.getElementById('edit_time').value = time;
        document.getElementById('edit_type').value = type;
        document.getElementById('edit_status').value = status;
        document.getElementById('edit_color').value = color;
        document.getElementById('edit_notes').value = notes;
        
        document.querySelectorAll('#edit_colors .color-dot').forEach(d => {
            d.classList.toggle('selected', d.dataset.color === color);
        });
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function selectColor(el, form) {
        el.parentElement.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById(form + '_color').value = el.dataset.color;
    }

    function deleteEntry() {
        if (confirm('Delete this entry?')) {
            document.getElementById('deleteForm').submit();
        }
    }

    // Close on overlay click
    document.querySelectorAll('.modal-overlay').forEach(m => {
        m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
    });

    // Close on Escape
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
    });

    // Restore view (URL param takes priority, then localStorage)
    const urlParams = new URLSearchParams(window.location.search);
    const urlView = urlParams.get('view');
    const savedView = localStorage.getItem('calendarView');
    
    if (urlView) {
        switchView(urlView);
    } else if (savedView) {
        switchView(savedView);
    }
    
    // Event delegation for clicking on entry cards and schedule items
    document.addEventListener('click', function(e) {
        // Find the closest entry-card or schedule-item
        const entryCard = e.target.closest('.entry-card[data-entry-id], .schedule-item[data-entry-id]');
        
        if (entryCard && !isDragging) {
            e.preventDefault();
            e.stopPropagation();
            
            const id = entryCard.dataset.entryId;
            const title = entryCard.dataset.title || '';
            const date = entryCard.dataset.date || '';
            const time = entryCard.dataset.time || '';
            const type = entryCard.dataset.type || 'custom';
            const desc = entryCard.dataset.desc || '';
            const status = entryCard.dataset.status || 'planned';
            const color = entryCard.dataset.color || '#0ea5e9';
            const notes = entryCard.dataset.notes || '';
            
            openEditModal(parseInt(id), title, date, time, type, desc, status, color, notes);
        }
    });
</script>
{% endblock %}
